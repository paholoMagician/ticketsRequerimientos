<div class="spinner-overlay" *ngIf="_show_spinner">
    <div class="spinner-container">
        <span class="loader"></span>
    </div>
</div>
<div class="p-2 rounded-2 shadow-sm" style="background-color: whitesmoke">
  <form [formGroup]="repuestoSearchForm" class="px-3 pt-3">
    <label for="" class="d-flex align-items-center fs-6">
      <mat-icon>search</mat-icon>
      <span>
        Repuestos <strong class="text-primary"> ( {{ listRepuestos.length }} ) </strong>:
        <small *ngIf="listRepuestos.length !== listRepuestosGhost.length" class="text-muted">
          (filtrados de {{ listRepuestosGhost.length }})
        </small>
      </span>
    </label>
    <input type="text"
      fxFlex="auto"
      (keyup)="filtroRepuestos()"
      class="form-control rounded-pill shadow-sm"
      formControlName="filter"
      #filter
      placeholder="Búsqueda del repuesto"
      id="filter"
    />
  </form>
  <div class="tabla table-responsive px-3">
    <div class="bordeTabla">
      <table class="table table-hover table-bordered table-secondary align-middle text-center">
        <thead>
          <th class="p-1 align-middle"><input type="checkbox" class="form-check-input" /></th>
          <th class="p-1 align-middle" [title]="'Cantidad facturada.'">#</th>
          <th class="p-1 align-middle">N. Parte</th>
          <th class="p-1 align-middle">Nombre Repuesto</th>
          <th class="p-1 align-middle">Marca Repuesto</th>
          <th class="p-1 align-middle">Descripción</th>
          <th class="p-1 align-middle">Marca Equipo</th>
          <th class="p-1 align-middle">Responsable</th>
          <th class="p-1 align-middle" [title]="'Cantidad en stock.'">Stock</th>
          <th class="p-1 align-middle" [title]="'Cantidad despchada.'">Stock Actualizado</th>
          <th class="p-1 align-middle">Precio Inv.</th>
          <th class="p-1 align-middle">Precio Real.</th>
          <th class="p-1 align-middle">I.V.A.</th>
          <th class="p-1 align-middle">Subtotal</th>
          <th class="p-1 align-middle">Total</th>
          <th class="p-1 align-middle"></th>
        </thead>
        <tbody>
          <tr *ngFor="let repuestos of getPaginatedItems(); let i = index">
            <td>
              <input type="checkbox"
                style="cursor: pointer"
                class="form-check-input"
                [disabled]="repuestos.cantRep == 0"
                [id]="'input-' + repuestos.codrep"
                [(ngModel)]="repuestos.selected"
                (click)="selectRow(repuestos)"
              />
            </td>
            <td>
              <!-- [value]="repuestos.cantDespacho" -->
              <input type="number"
                class="form-control form-control-sm"
                [disabled]="repuestos.cantRep == 0"
                style="width: 60px; text-align: right"
                (keyup)="cantidadDespacho('input-cant-' + repuestos.codrep, repuestos, null)"
                (change)="cantidadDespacho('input-cant-' + repuestos.codrep, repuestos, null)"
                [id]="'input-cant-' + repuestos.codrep"
                placeholder="0"
                [max]="repuestos.cantStock"
              />
            </td>
            <td>
              {{ repuestos.codigo }}
            </td>
            <td (click)="selectRow(repuestos)" style="cursor: pointer"
              [title]="'Bodega: ' + repuestos.nombrebodega + ' - Fecha de registro del repuesto al sistema: ' + (repuestos.fecrea | date : 'short')">
              {{ repuestos.nombreRep }}
            </td>
            <td (click)="selectRow(repuestos)" style="cursor: pointer">
              {{ repuestos.marcaRepuesto }}
            </td>
            <td (click)="selectRow(repuestos)" style="cursor: pointer">
              {{ repuestos.descripcion }}
            </td>
            <td (click)="selectRow(repuestos)" style="cursor: pointer">
              {{ repuestos.nombreMarcaEquipo }}
            </td>
            <td (click)="selectRow(repuestos)" style="cursor: pointer">
              {{ repuestos.nombreUsuario }}
            </td>
            <td style="text-align: right; cursor: pointer" (click)="selectRow(repuestos)">
              <strong> {{ repuestos.cantRep }} </strong>
            </td>
            <td>
              <div class="d-flex justify-content-center align-items-center">
                <input type="number"
                  class="form-control form-control-sm"
                  disabled
                  [value]="repuestos.cantStock"
                  [style]="'width: 70px; text-align: right; background-color: '+ repuestos.colorAdvertenceBg +' !important; color: ' + repuestos.colorAdvertenceFg + ' !important; '"
                  [id]="'input-cant-stock-' + repuestos.codrep"
                  min="0" step="1"
                />
              </div>
            </td>
            <td style="background-color: rgb(80, 80, 80) !important;color: whitesmoke;text-align: right;">
              {{ repuestos.pvp | number : "1.2-2" }}
            </td>
            <td [style]="'background-color: ' + repuestos.colorInputStatus +'; color: whitesmoke; text-align: right;'">
              <div class="d-flex justify-content-center align-items-center">
                <input type="number"
                       placeholder="0.00"
                       class="form-control form-control-sm"
                       [id]="'input-pvp-reval-' + repuestos.codrep"
                       [min]="repuestos.pvp"
                       [value]="repuestos.pvp.toFixed(2)"
                       (keyup)="cantidadDespacho('input-cant-' + repuestos.codrep, repuestos, $event)"
                       (change)="cantidadDespacho('input-cant-' + repuestos.codrep, repuestos, $event)"
                       style="width: 95px; text-align: right"
                       step="0.01"
                       >
              </div>
            </td>
            <td [title]="repuestos.iva + ' %'" style="background-color: rgb(71, 71, 71) !important; color: whitesmoke; text-align: right;">
              {{ repuestos.ivAvalor | number : "1.2-2" }}
            </td>
            <td style="background-color: rgb(57, 57, 57) !important; color: whitesmoke; text-align: right;">
              {{ repuestos.pvpIVA | number : "1.2-2" }}
            </td>
            <td style="background-color: rgb(156, 215, 212) !important; text-align: right;">
              {{ repuestos.totalPVP | number : "1.2-2" }}
            </td>
            <td [title]="repuestos.desc_calculo" style="background-color: rgb(57, 57, 57) !important; color: whitesmoke;">
              <mat-icon [style]="'color: ' + repuestos.color_calculo + ';'">
                {{ repuestos.icon_calculo }}
              </mat-icon>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted">
          Mostrando {{ getDisplayRange() }} de 
          {{ listRepuestos.length }} registros
        </div>
        <nav>
          <ul class="pagination">
            <!-- Botón Primera Página -->
            <li class="page-item" [class.disabled]="currentPage === 1">
              <a class="page-link" (click)="goToFirstPage()" title="Primera página">&laquo;&laquo;</a>
            </li>
            
            <!-- Botón Página Anterior -->
            <li class="page-item" [class.disabled]="currentPage === 1">
              <a class="page-link" (click)="previousPage()" title="Página anterior">&laquo;</a>
            </li>
            
            <!-- Números de Página -->
            <li class="page-item" *ngFor="let page of getPages()" [class.active]="page === currentPage">
              <a class="page-link" (click)="setPage(page)">{{ page }}</a>
            </li>
            
            <!-- Botón Página Siguiente -->
            <li class="page-item" [class.disabled]="currentPage === totalPages()">
              <a class="page-link" (click)="nextPage()" title="Página siguiente">&raquo;</a>
            </li>
            
            <!-- Botón Última Página -->
            <li class="page-item" [class.disabled]="currentPage === totalPages()">
              <a class="page-link" (click)="goToLastPage()" title="Última página">&raquo;&raquo;</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
  <div class="table-responsive-lg mt-2 d-flex justify-content-end">
    <div style="background-color: rgb(47, 47, 47) !important; text-align: right"
      class="p-3 rounded-2 shadow-sm fs-3 d-flex flex-column">
      <small style="font-size: 9pt; color: whitesmoke">CANTIDAD</small>
      <strong style="color: rgb(151, 219, 216) !important">
        {{ cantidadDespachada }}
      </strong>
    </div>
    &nbsp;&nbsp;
    <div style="background-color: rgb(70, 70, 70) !important; text-align: right"
      class="p-3 rounded-2 shadow-sm fs-3 d-flex flex-column">
      <small style="font-size: 9pt; color: whitesmoke">SUB TOTAL</small>
      <strong style="color: rgb(151, 219, 216) !important">
        $ {{ calculoSubTotales | number : "1.2-2" }}
      </strong>
    </div>
    &nbsp;&nbsp;
    <div style="background-color: rgb(151, 219, 216) !important; text-align: right"
      class="p-3 rounded-2 shadow-sm fs-3 d-flex flex-column">
      <small style="font-size: 9pt; color: rgb(84, 84, 84)">TOTAL P.V.P.</small>
      <strong> $ {{ calculoTotalFactur | number : "1.2-2" }} </strong>
    </div>
  </div>
  <hr />
  <div class="w-100 d-flex justify-content-end" style="background-color: whitesmoke">
    <button class="btn btn-primary d-flex align-items-center btn-sm" (click)="closeDialog()"
     [disabled]="calculoTotalFactur == 0">
      <mat-icon>done</mat-icon>
      <span> Crear pedido </span>
    </button>
  </div>
</div>
